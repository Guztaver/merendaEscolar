<div class="container">
    <div class="header">
        <div class="header-title">
            <a [routerLink]="['/logistics/stock-items']" class="back-link">‚Üê Voltar para Itens</a>
            <h1 class="text-2xl font-bold text-gray-800">
                {{ isEdit() ? 'Editar Item do Estoque' : 'Novo Item do Estoque' }}
            </h1>
            <p class="text-gray-600">
                {{ isEdit() ? 'Atualize as informa√ß√µes do item' : 'Cadastre um novo item no estoque' }}
            </p>
        </div>
    </div>

    <!-- Mensagens de Feedback -->
    @if (successMessage()) {
        <div class="alert alert-success">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                <polyline points="22 4 12 14.01 9 11.01"/>
            </svg>
            <span>{{ successMessage() }}</span>
        </div>
    }

    @if (errorMessage()) {
        <div class="alert alert-error">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"/>
                <line x1="12" y1="8" x2="12" y2="12"/>
                <line x1="12" y1="16" x2="12.01" y2="16"/>
            </svg>
            <span>{{ errorMessage() }}</span>
            <button class="alert-close" (click)="errorMessage.set('')">&times;</button>
        </div>
    }

    @if (loading()) {
        <div class="loading">Carregando...</div>
    } @else {
        <form class="form">
            <div class="form-section">
                <h2 class="section-title">Informa√ß√µes B√°sicas</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="code" class="form-label">C√≥digo do Item *</label>
                        <input
                            type="text"
                            id="code"
                            class="form-control"
                            [value]="item().code"
                            (input)="updateField('code', $any($event.target).value)"
                            placeholder="Ex: ARROZ-001"
                            [class.error]="hasError('code')"
                        />
                        @if (hasError('code')) {
                            <small class="error-text">{{ getError('code') }}</small>
                        }
                    </div>

                    <div class="form-group">
                        <label for="name" class="form-label">Nome do Item *</label>
                        <input
                            type="text"
                            id="name"
                            class="form-control"
                            [value]="item().name"
                            (input)="updateField('name', $any($event.target).value)"
                            placeholder="Ex: Arroz Tipo 1"
                            [class.error]="hasError('name')"
                        />
                        @if (getError('name')) {
                            <small class="error-text">{{ getError('name') }}</small>
                        }
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="type" class="form-label">Tipo de Item *</label>
                        <select
                            id="type"
                            class="form-control"
                            [value]="item().type"
                            (change)="updateField('type', $any($event.target).value)"
                        >
                            @for (option of typeOptions; track option.value) {
                                <option [value]="option.value">{{ option.label }}</option>
                            }
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="location" class="form-label">Localiza√ß√£o *</label>
                        <input
                            type="text"
                            id="location"
                            class="form-control"
                            [value]="item().location"
                            (input)="updateField('location', $any($event.target).value)"
                            placeholder="Ex: Despensa A, Prateleira 3"
                            [class.error]="getError('location')"
                        />
                        @if (getError('location')) {
                            <small class="error-text">{{ getError('location') }}</small>
                        }
                    </div>
                </div>
            </div>

            <div class="form-section">
                <h2 class="section-title">Quantidade e Limites</h2>

                <div class="form-row">
                    <div class="form-group">
                        <label for="currentQuantity" class="form-label">Quantidade Atual *</label>
                        <input
                            type="number"
                            id="currentQuantity"
                            class="form-control"
                            [value]="item().currentQuantity"
                            (input)="updateField('currentQuantity', toNumber($any($event.target).value))"
                            min="0"
                            step="0.01"
                            [class.error]="getError('currentQuantity')"
                        />
                        @if (getError('currentQuantity')) {
                            <small class="error-text">{{ getError('currentQuantity') }}</small>
                        }
                    </div>

                    <div class="form-group">
                        <label for="unit" class="form-label">Unidade de Medida *</label>
                        <select
                            id="unit"
                            class="form-control"
                            [value]="item().unit"
                            (change)="updateField('unit', $any($event.target).value)"
                        >
                            @for (option of unitOptions; track option.value) {
                                <option [value]="option.value">{{ option.label }}</option>
                            }
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="minQuantity" class="form-label">Quantidade M√≠nima *</label>
                        <input
                            type="number"
                            id="minQuantity"
                            class="form-control"
                            [value]="item().minQuantity"
                            (input)="updateField('minQuantity', toNumber($any($event.target).value))"
                            min="0"
                            step="0.01"
                            [class.error]="getError('minQuantity')"
                        />
                        @if (getError('minQuantity')) {
                            <small class="error-text">{{ getError('minQuantity') }}</small>
                        }
                        <small class="help-text">Alerta ser√° criado quando o estoque atingir este valor</small>
                    </div>

                    <div class="form-group">
                        <label for="maxCapacity" class="form-label">Capacidade M√°xima *</label>
                        <input
                            type="number"
                            id="maxCapacity"
                            class="form-control"
                            [value]="item().maxCapacity"
                            (input)="updateField('maxCapacity', toNumber($any($event.target).value))"
                            min="0"
                            step="0.01"
                            [class.error]="getError('maxCapacity')"
                        />
                        @if (getError('maxCapacity')) {
                            <small class="error-text">{{ getError('maxCapacity') }}</small>
                        }
                        <small class="help-text">Alerta de estoque excessivo ser√° criado</small>
                    </div>
                </div>

                <!-- Visualiza√ß√£o dos limites -->
                @if (item().currentQuantity !== undefined && item().minQuantity !== undefined && item().maxCapacity !== undefined) {
                    <div class="limits-preview" [class.warning]="item().currentQuantity! <= item().minQuantity! || item().currentQuantity! >= item().maxCapacity!">
                        <div class="preview-title">üìä Visualiza√ß√£o dos Limites</div>
                        <div class="preview-bar">
                            <div class="bar-fill"
                                 [class.warning]="item().currentQuantity! <= item().minQuantity! || item().currentQuantity! >= item().maxCapacity!"
                                 [class.critical]="item().currentQuantity! > item().maxCapacity! || item().currentQuantity! < item().minQuantity!"
                                 [style.width.%]="(item().currentQuantity! / item().maxCapacity!) * 100"></div>
                        </div>
                        <div class="preview-info">
                            <div class="info-item">
                                <span class="info-label">Atual:</span>
                                <span class="info-value">{{ item().currentQuantity }} {{ item().unit }}</span>
                            </div>
                            <div class="info-item info-min">
                                <span class="info-label">M√≠nimo:</span>
                                <span class="info-value">{{ item().minQuantity }} {{ item().unit }}</span>
                            </div>
                            <div class="info-item info-max">
                                <span class="info-label">M√°ximo:</span>
                                <span class="info-value">{{ item().maxCapacity }} {{ item().unit }}</span>
                            </div>
                        </div>
                        @if (item().currentQuantity! <= item().minQuantity!) {
                            <div class="preview-warning">‚ö†Ô∏è Estoque abaixo do m√≠nimo!</div>
                        } @else if (item().currentQuantity! >= item().maxCapacity!) {
                            <div class="preview-warning">üì¶ Estoque na capacidade m√°xima!</div>
                        }
                    </div>
                }
            </div>

            <div class="form-section">
                <h2 class="section-title">Informa√ß√µes Financeiras</h2>

                <div class="form-group">
                    <label for="unitCost" class="form-label">Custo Unit√°rio (R$) *</label>
                    <div class="input-group">
                        <span class="input-prefix">R$</span>
                        <input
                            type="number"
                            id="unitCost"
                            class="form-control"
                            [value]="item().unitCost"
                            (input)="updateField('unitCost', toNumber($any($event.target).value))"
                            min="0"
                            step="0.01"
                            placeholder="0,00"
                            [class.error]="getError('unitCost')"
                        />
                    </div>
                    @if (getError('unitCost')) {
                        <small class="error-text">{{ getError('unitCost') }}</small>
                    }
                </div>

                @if (item().currentQuantity && item().unitCost) {
                    <div class="total-value">
                        üí∞ Valor Total em Estoque: <strong>
                            {{ item().currentQuantity! * item().unitCost! | currency:'BRL' }}
                        </strong>
                    </div>
                }
            </div>

            <div class="form-section">
                <h2 class="section-title">Status</h2>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input
                            type="checkbox"
                            class="checkbox"
                            [checked]="item().isActive"
                            (change)="updateField('isActive', $any($event.target).checked)"
                        />
                        <span>Item Ativo</span>
                    </label>
                    <small class="help-text">Itens inativos n√£o aparecem nas listagens por padr√£o</small>
                </div>
            </div>
        </form>

        <div class="form-actions">
            <a [routerLink]="['/logistics/stock-items']" class="btn btn-secondary" [class.disabled]="submitting()">Cancelar</a>
            <button
                type="button"
                class="btn btn-primary"
                [disabled]="submitting()"
                [class.loading]="submitting()"
                (click)="onSubmit()"
            >
                @if (submitting()) {
                    <svg class="spinner" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" class="spinner-track"/>
                        <path d="M12 2a10 10 0 0 1 10 10" stroke="currentColor" stroke-width="4" class="spinner-path"/>
                    </svg>
                    <span>Salvando...</span>
                } @else {
                    <span>{{ isEdit() ? 'Atualizar Item' : 'Criar Item' }}</span>
                }
            </button>
        </div>
    }
</div>
